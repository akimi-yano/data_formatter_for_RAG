<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structure & Extract AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Icon wrapper since Lucide script doesn't auto-expose React components
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        function App() {
            const [files, setFiles] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [results, setResults] = useState([]);
            const [dragActive, setDragActive] = useState(false);

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    setFiles(Array.from(e.dataTransfer.files));
                }
            };

            const handleChange = (e) => {
                e.preventDefault();
                if (e.target.files && e.target.files[0]) {
                    setFiles(Array.from(e.target.files));
                }
            };

            // Configuration: Set this to your backend URL in production
            // Example: const API_BASE_URL = "https://your-app-name.onrender.com";
            const API_BASE_URL = "http://localhost:8000"; 
            
            const handleUpload = async () => {
                if (files.length === 0) return;
                setIsLoading(true);

                const formData = new FormData();
                files.forEach(file => {
                    formData.append("files", file);
                });

                try {
                    const response = await fetch(`${API_BASE_URL}/upload`, {
                        method: "POST",
                        body: formData
                    });

                    if (!response.ok) throw new Error("Upload failed");

                    const data = await response.json();
                    setResults(data.results);
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error uploading files. Ensure backend is running and API_BASE_URL is correct.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDownload = async (content, format, filenameBase) => {
                try {
                    // Remove extension from original filename if present to avoid "file.pdf_extracted.pdf"
                    const base = filenameBase.replace(/\.[^/.]+$/, "");

                    const response = await fetch("http://localhost:8000/download", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            content: content,
                            format: format,
                            filename: base + "_extracted"
                        })
                    });

                    if (!response.ok) throw new Error("Download failed");

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${base}_extracted.${format}`; // Backend header also handles this
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error("Download Error:", error);
                    alert("Failed to download file.");
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-8">
                    <header className="mb-10 text-center">
                        <h1 className="text-4xl font-extrabold text-slate-800 mb-2 tracking-tight">
                            Structure & <span className="text-indigo-600">Extract AI</span>
                        </h1>
                        <p className="text-slate-500 text-lg">
                            Upload documents, extract structured data, and download in any format.
                        </p>
                    </header>

                    {/* Upload Section */}
                    <div
                        className={`mb-10 p-10 border-2 border-dashed rounded-2xl text-center transition-all duration-300 ${dragActive ? "border-indigo-500 bg-indigo-50" : "border-slate-300 hover:border-indigo-400 bg-white"
                            }`}
                        onDragEnter={handleDrag}
                        onDragLeave={handleDrag}
                        onDragOver={handleDrag}
                        onDrop={handleDrop}
                    >
                        <input
                            id="file-upload"
                            type="file"
                            multiple
                            className="hidden"
                            onChange={handleChange}
                            accept=".pdf,.docx,.pptx"
                        />
                        <label htmlFor="file-upload" className="cursor-pointer">
                            <div className="flex flex-col items-center">
                                <Icon name="upload-cloud" size={48} className="text-indigo-500 mb-4" />
                                <p className="text-xl font-medium text-slate-700">
                                    Drag & drop files here, or <span className="text-indigo-600 underline">browse</span>
                                </p>
                                <p className="text-sm text-slate-400 mt-2">
                                    Supports PDF, Word, PowerPoint
                                </p>
                            </div>
                        </label>
                        {files.length > 0 && (
                            <div className="mt-6 flex flex-wrap gap-2 justify-center">
                                {files.map((f, i) => (
                                    <span key={i} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">
                                        {f.name}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>


                    <div className="text-center mb-12">
                        <button
                            onClick={handleUpload}
                            disabled={files.length === 0 || isLoading}
                            className={`px-8 py-3 rounded-full text-white font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 ${files.length === 0 || isLoading
                                ? "bg-slate-400 cursor-not-allowed"
                                : "bg-indigo-600 hover:bg-indigo-700"
                                }`}
                        >
                            {isLoading ? "Processing..." : "Start Extraction"}
                        </button>
                    </div>

                    {/* Results Section */}
                    <div className="space-y-8">
                        {results.map((res, idx) => (
                            <div key={idx} className="glass-panel p-6 rounded-xl border-l-4 border-indigo-500">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="file-text" size={20} className="text-slate-500" />
                                        {res.filename}
                                    </h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleDownload(res.ai_response, 'md', res.filename)}
                                            className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            MD
                                        </button>
                                        <button
                                            onClick={() => handleDownload(res.ai_response, 'txt', res.filename)}
                                            className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            TXT
                                        </button>
                                        <button
                                            onClick={() => handleDownload(res.ai_response, 'pdf', res.filename)}
                                            className="px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg text-sm font-medium transition-colors"
                                        >
                                            PDF
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-slate-50 p-4 rounded-lg overflow-x-auto border border-slate-200">
                                    <pre className="text-sm text-slate-600 whitespace-pre-wrap">{res.ai_response}</pre>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>